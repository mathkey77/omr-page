<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OMR 채점 페이지</title>
  <style>
    body { font-family: "Times New Roman", serif; text-align: center; }
    .container { max-width: 800px; margin: auto; }
    .form-section { margin: 20px 0; }
    .question { margin: 15px 0; }
    .options { display: flex; justify-content: space-around; margin-top: 10px; }
    .option {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px; height: 30px;
      border: 2px solid black;
      border-radius: 50px; /* 타원 모양 */
      cursor: pointer;
    }
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + label {
      background-color: black;
      color: white;
    }
    button {
      margin: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #333;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    #result { margin-top: 20px; font-weight: bold; font-size: 18px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>OMR 채점 시스템</h2>

    <!-- 학년 선택 -->
    <div class="form-section">
      <label for="grade">학년 선택:</label>
      <select id="grade">
        <option value="중1">중1</option>
        <option value="중2">중2</option>
        <option value="중3">중3</option>
        <option value="고1">고1</option>
        <option value="고2">고2</option>
        <option value="고3">고3</option>
      </select>
    </div>

    <!-- 시험지 종류 선택 -->
    <div class="form-section">
      <label for="exam">시험지 종류:</label>
      <select id="exam">
        <option value="A">A형</option>
        <option value="B">B형</option>
        <option value="C">C형</option>
      </select>
    </div>

    <!-- 문제 표시 (예시 5문제) -->
    <form id="omrForm">
      <div id="questions"></div>
      <button type="button" onclick="submitAndGrade()">채점하기</button>
      <button type="button" onclick="fetchAnswers()">정답 다시 불러오기</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycby-mybSTj7Ay6675T8IHPrVX0Vr4bU_DzBvvv_ze0dy2zz5foX_sShBqwrjnQbcYLTJ/exec"; // Google Apps Script Web App URL
    let answerKey = {};

    // 문제 생성 (예시: 5문제)
    function renderQuestions() {
      const qDiv = document.getElementById("questions");
      qDiv.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        let qHtml = `<div class="question">
          <div>문제 ${i}</div>
          <div class="options">`;
        for (let j = 1; j <= 5; j++) {
          qHtml += `
            <input type="radio" name="q${i}" id="q${i}_${j}" value="${j}">
            <label class="option" for="q${i}_${j}">${j}</label>
          `;
        }
        qHtml += `</div></div>`;
        qDiv.innerHTML += qHtml;
      }
    }

    // 정답 불러오기
    async function fetchAnswers() {
      const grade = document.getElementById("grade").value;
      const exam = document.getElementById("exam").value;

      try {
        const res = await fetch(`${scriptUrl}?action=getAnswers&grade=${grade}&exam=${exam}`);
        const data = await res.json();
        if (data.success) {
          answerKey = data.answers;
          alert("정답 불러오기 완료!");
          console.log("불러온 정답:", answerKey);
        } else {
          alert("정답 불러오기 실패 — 관리자에게 확인하세요.");
        }
      } catch (err) {
        console.error("fetchAnswers error:", err);
        alert("정답 불러오기 중 오류 발생");
      }
    }

    // 채점
    async function submitAndGrade() {
      const grade = document.getElementById("grade").value;
      const exam = document.getElementById("exam").value;

      let score = 0;
      let total = Object.keys(answerKey).length;

      for (let i = 1; i <= total; i++) {
        let selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (selected && answerKey[`q${i}`] == selected.value) {
          score++;
        }
      }

      document.getElementById("result").innerText =
        `점수: ${score} / ${total}`;

      try {
        await fetch(scriptUrl, {
          method: "POST",
          body: new URLSearchParams({
            action: "saveResult",
            grade: grade,
            exam: exam,
            score: score,
            total: total
          })
        });
      } catch (err) {
        console.error("submitAndGrade error:", err);
      }
    }

    // 초기 렌더링
    document.addEventListener("DOMContentLoaded", () => {
      renderQuestions();
    });
  </script>
</body>
</html>
