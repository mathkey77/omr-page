<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OMR 테스트 (학생 ID 포함)</title>
<style>
  /* 기존 OMR 스타일 유지 (클래식 폰트 + 타원형 보기) */
  body { font-family: Georgia, "Times New Roman", serif; background:#f5f5f5; margin:0; padding:24px; display:flex; justify-content:center; }
  .container { max-width:920px; width:100%; background:#fff; padding:28px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.12); }
  h1 { text-align:center; color:#1e3a8a; margin:0 0 18px 0; font-weight:normal; }
  .controls { display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:16px; flex-wrap:wrap; }
  .control-item { display:flex; flex-direction:column; align-items:flex-start; font-size:14px; color:#333; }
  select, input[type="text"] { padding:8px 10px; border-radius:6px; border:1px solid #cfd6df; font-size:14px; min-width:120px; }
  #omrForm { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
  .question { display:flex; align-items:center; gap:16px; padding:8px 6px; border-bottom:1px dashed #eee; }
  .qnum { width:40px; text-align:right; font-weight:bold; color:#333; }
  .options { display:flex; gap:12px; align-items:center; }

  /* 타원형 보기 (세로로 긴) */
  .option {
    width:36px; height:50px; border:2px solid #bfbfbf; border-radius:18px;
    display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    font-weight:bold; font-size:16px; background:#fff; transition:all .15s;
  }
  .option input { display:none; }
  .option.checked { background:#1e40af; color:#fff; border-color:#1e40af; box-shadow:0 2px 6px rgba(30,64,175,.18); }

  .actions { text-align:center; margin-top:16px; display:flex; justify-content:center; gap:12px; }
  button { padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; background:#1e40af; color:#fff; }
  button.secondary { background:#047857; }

  #result { text-align:center; margin-top:14px; font-size:18px; font-weight:bold; color:#065f46; }
  .status { text-align:center; margin-top:8px; font-size:13px; color:#666; }
  .status.success { color:#0b7a4f; }
  .status.fail { color:#b91c1c; }

  pre.debug { white-space:pre-wrap; background:#f8fafc; border:1px solid #e6eef8; padding:10px; border-radius:6px; margin-top:12px; font-size:12px; max-height:240px; overflow:auto; }
  @media (max-width:560px){ .question{gap:10px;} .options{gap:8px;} .controls{flex-direction:column; align-items:stretch;} }
</style>
</head>
<body>
  <div class="container">
    <h1>주간테스트 OMR</h1>

    <!-- Controls: 학년 / 시험지 / 학생ID -->
    <div class="controls">
      <div class="control-item">
        <label for="grade">학년</label>
        <select id="grade">
          <option>중1</option><option>중2</option><option>중3</option>
          <option>고1</option><option>고2</option><option>고3</option>
        </select>
      </div>

      <div class="control-item">
        <label for="exam">시험지</label>
        <select id="exam">
          <option value="A">A형</option><option value="B">B형</option><option value="C">C형</option>
        </select>
      </div>

      <div class="control-item">
        <label for="studentId">학생 ID</label>
        <input id="studentId" type="text" placeholder="예: 2025001" />
      </div>
    </div>

    <!-- OMR form -->
    <div id="omrForm" aria-live="polite"></div>

    <!-- actions -->
    <div class="actions">
      <button id="gradeBtn">채점</button>
      <button id="reloadAnswers" class="secondary">정답 다시 불러오기</button>
    </div>

    <div id="result"></div>
    <div id="answerStatus" class="status"></div>

    <h3 style="margin-top:18px">디버그 로그 (개발용)</h3>
    <pre id="debugLog" class="debug">콘솔 로그가 여기에 출력됩니다.</pre>
  </div>

<script>
/* ===== 설정 ===== */
const TOTAL_QUESTIONS = 15;
const WEBAPP_URL = '<https://script.google.com/macros/s/AKfycbw3WieZURxBBggTHHBc6m09pqHuvhehuqhJ4c8YPUYVfsb4wMAAxxaCwPtsJkQvdEf_/exec>'; // ← 여기에 Apps Script 웹앱 URL 넣으세요 (끝에 /exec 포함)

/* ===== 유틸 ===== */
function log(msg){
  console.log(msg);
  const el = document.getElementById('debugLog');
  if(!el) return;
  el.textContent = (el.textContent ? el.textContent + '\n' : '') + msg;
  if(el.textContent.length > 20000) el.textContent = el.textContent.slice(-20000);
}
function setStatus(msg, type=''){ const el=document.getElementById('answerStatus'); if(el){ el.textContent=msg; el.className='status'+(type? ' '+type:''); } log('[STATUS] '+msg); }
function $(id){ return document.getElementById(id) || null; }

/* ===== 폼 생성 ===== */
function buildForm(){
  const omrForm = $('omrForm');
  if(!omrForm){ log('buildForm: omrForm not found'); return; }
  omrForm.innerHTML = '';
  for(let i=1;i<=TOTAL_QUESTIONS;i++){
    const q = document.createElement('div'); q.className='question';
    q.innerHTML = `<div class="qnum">${i}</div><div class="options" data-q="${i}"></div>`;
    const options = q.querySelector('.options');
    for(let j=1;j<=5;j++){
      const lbl = document.createElement('label'); lbl.className='option';
      lbl.innerHTML = `<input type="radio" name="q${i}" value="${j}">${j}`;
      lbl.querySelector('input').addEventListener('change', function(){
        options.querySelectorAll('.option').forEach(o=>o.classList.remove('checked'));
        lbl.classList.add('checked');
      });
      options.appendChild(lbl);
    }
    omrForm.appendChild(q);
  }
}

/* ===== 정답 불러오기 (fetch -> JSONP 폴백) ===== */
let correctAnswers = {};
let lastFetch = {grade:'', exam:''};

async function fetchAnswers(){
  const gradeEl = $('grade'), examEl = $('exam');
  if(!gradeEl || !examEl){ setStatus('학년/시험지 선택 UI를 찾을 수 없음','fail'); log('fetchAnswers: missing UI'); return; }
  const grade = gradeEl.value, exam = examEl.value;
  const url = `${WEBAPP_URL}?grade=${encodeURIComponent(grade)}&exam=${encodeURIComponent(exam)}`;
  log('fetchAnswers -> ' + url);

  if(lastFetch.grade===grade && lastFetch.exam===exam && Object.keys(correctAnswers).length){
    setStatus('정답: 캐시 사용됨','success'); return;
  }

  setStatus('정답 불러오는 중...','');
  try {
    const res = await fetch(url);
    log('fetch status: ' + res.status + ' ' + res.statusText);
    const text = await res.text();
    log('fetch raw: ' + text);
    let data;
    try { data = JSON.parse(text); } catch(e){ throw new Error('서버 응답 JSON 파싱 실패'); }
    if(data && data.error) throw new Error('서버 오류: ' + data.error);
    correctAnswers = data || {};
    lastFetch = {grade, exam};
    setStatus('정답 불러오기 성공 (fetch)','success');
    return;
  } catch(err){
    log('fetch failed: ' + err);
    setStatus('fetch 실패 — JSONP 폴백 시도','fail');
    return new Promise((resolve, reject) => {
      const cbName = 'jsonp_cb_' + Date.now();
      window[cbName] = function(data){
        delete window[cbName];
        script.remove();
        log('JSONP cb data: ' + JSON.stringify(data));
        if(data && data.error){ setStatus('정답 불러오기 실패 — 서버 오류','fail'); reject(data); }
        else { correctAnswers = data || {}; lastFetch = {grade, exam}; setStatus('정답 불러오기 성공 (jsonp)','success'); resolve(data); }
      };
      const script = document.createElement('script');
      script.src = `${url}&callback=${cbName}`;
      script.onerror = function(e){ delete window[cbName]; script.remove(); log('JSONP load error'); setStatus('정답 불러오기 실패 — JSONP 로드 실패','fail'); reject(e); };
      document.head.appendChild(script);
    });
  }
}

/* ===== 채점 및 기록 ===== */
async function submitAndGrade(){
  const gradeEl = $('grade'), examEl = $('exam'), studentEl = $('studentId');
  if(!gradeEl || !examEl || !studentEl){ alert('학년/시험지/학생ID 입력란을 확인하세요'); return; }
  const grade = gradeEl.value, exam = examEl.value, studentId = studentEl.value.trim();
  if(!studentId){ alert('학생 ID를 입력해주세요'); return; }

  // 최신 정답 불러오기(실패해도 채점은 진행)
  await fetchAnswers();

  let score = 0, details = '';
  for(let i=1;i<=TOTAL_QUESTIONS;i++){
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    const val = sel ? sel.value : '-';
    const key = 'q' + i;
    if(correctAnswers[key] && String(correctAnswers[key]) === String(val)) score++;
    details += `Q${i}:${val} `;
  }

  $('result').innerText = `${studentId} 님 점수: ${score} / ${TOTAL_QUESTIONS}`;
  log(`채점 -> studentId=${studentId} grade=${grade} exam=${exam} score=${score}`);

  // 서버 기록 (POST, 헤더 없이)
  const payload = { grade, exam, studentId, score, time: new Date().toLocaleString(), details };
  try {
    const res = await fetch(WEBAPP_URL, { method: 'POST', body: JSON.stringify(payload) });
    const text = await res.text();
    log('POST status: ' + res.status + ' raw: ' + text);
    try {
      const data = JSON.parse(text);
      if(data && data.status === 'success') setStatus('점수 표시 및 기록 전송 완료','success');
      else setStatus('기록전송 후 서버 응답 비정상 (콘솔 확인)','fail');
    } catch(e){
      log('POST 응답 JSON 파싱 실패: ' + e);
      setStatus('기록 전송(응답 파싱 실패)','fail');
    }
  } catch(e){
    log('POST 실패: ' + e);
    setStatus('구글 시트 기록 실패 — 네트워크/웹앱 설정 확인','fail');
  }
}

/* ===== 초기화 ===== */
document.addEventListener('DOMContentLoaded', () => {
  try {
    buildForm();
    const gBtn = $('gradeBtn'), rBtn = $('reloadAnswers');
    if(gBtn) gBtn.addEventListener('click', submitAndGrade);
    if(rBtn) rBtn.addEventListener('click', () => { lastFetch = {grade:'', exam:''}; fetchAnswers(); });
    // 초기 정답 불러오기 시도 (UI는 준비된 상태)
    fetchAnswers().catch(e => log('Initial fetchAnswers error: ' + e));
    log('Initialization complete.');
  } catch(err){
    log('Init error: ' + err);
    setStatus('초기화 중 오류 발생(콘솔 확인)','fail');
  }
});
</script>
</body>
</html>

